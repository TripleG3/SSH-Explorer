<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:SSHExplorer.ViewModels"
             xmlns:sftp="clr-namespace:Renci.SshNet.Sftp;assembly=Renci.SshNet"
             xmlns:io="clr-namespace:System.IO;assembly=System.IO.FileSystem"
             x:Class="SSHExplorer.Views.MainPage"
             x:Name="RootPage"
             x:DataType="vm:MainViewModel"
         Title="SSH Explorer">
    <Grid RowDefinitions="Auto,* ,Auto">
        <!-- Toolbar -->
        <HorizontalStackLayout Padding="8" Spacing="8">
            <Picker Title="Profile" ItemsSource="{Binding Profiles}" ItemDisplayBinding="{Binding Name}" SelectedItem="{Binding SelectedProfile}" WidthRequest="250"/>
            <Button Text="Connect" Command="{Binding ConnectCommand}"/>
        <!-- Connection status indicator (visible only when connected). Click to disconnect with confirmation. -->
        <Button Text="● Connected" TextColor="Lime" BackgroundColor="Transparent" BorderColor="Lime" BorderWidth="1"
            IsVisible="{Binding IsConnected}"
            Command="{Binding DisconnectCommand}"/>
        <Button Text="Terminal" Command="{Binding ToggleTerminalCommand}"/>
            <Button Text="Theme" Command="{Binding ToggleThemeCommand}"/>
            <Button Text="Commands" Clicked="OnCommandsClicked"/>
        <Button Text="About" Clicked="OnAboutClicked"/>
        </HorizontalStackLayout>

        <!-- Dual Pane Explorer -->
    <Grid x:Name="ExplorerGrid" Grid.Row="1" ColumnDefinitions="*,*">
            <!-- Remote Pane -->
        <Grid Grid.Column="0" Padding="8" RowDefinitions="Auto,Auto,Auto,*">
                <Label Grid.Row="0" Text="Remote" FontAttributes="Bold"/>
                <HorizontalStackLayout Grid.Row="1" Spacing="8">
            <Button Text="◀" Command="{Binding GoBackRemoteCommand}"/>
            <Button Text="⟲" Command="{Binding RefreshRemoteCommand}"/>
                </HorizontalStackLayout>
                <Entry Grid.Row="2" Text="{Binding RemotePath}"/>
                <CollectionView Grid.Row="3" ItemsSource="{Binding RemoteItems}" SelectedItem="{Binding SelectedRemoteItem}" SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="sftp:SftpFile">
                            <Grid Padding="6" InputTransparent="False">
                                <Label Text="{Binding Name}"/>
                                <Grid.GestureRecognizers>
                                    <DragGestureRecognizer CanDrag="True" DragStarting="OnRemoteDragStarting" />
                                    <TapGestureRecognizer NumberOfTapsRequired="2"
                                                         Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.OpenRemoteFolderCommand}"
                                                         CommandParameter="{Binding .}" />
                                    <TapGestureRecognizer NumberOfTapsRequired="1"
                                                         Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.ShowRemoteActionsCommand}"
                                                         CommandParameter="{Binding .}" />
                                    <TapGestureRecognizer Buttons="Secondary"
                                                         Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.ShowRemoteActionsCommand}"
                                                         CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <Grid.GestureRecognizers>
                    <DropGestureRecognizer AllowDrop="True" Drop="OnRemoteDrop" />
                </Grid.GestureRecognizers>
            </Grid>

            <!-- Local Pane -->
            <Grid Grid.Column="1" Padding="8" RowDefinitions="Auto,Auto,Auto,*">
                <Label Grid.Row="0" Text="Local" FontAttributes="Bold"/>
                <HorizontalStackLayout Grid.Row="1" Spacing="8">
            <Button Text="◀" Command="{Binding GoBackLocalCommand}"/>
            <Button Text="⟲" Command="{Binding RefreshLocalCommand}"/>
                </HorizontalStackLayout>
                <Entry Grid.Row="2" Text="{Binding LocalPath}"/>
                <CollectionView Grid.Row="3" ItemsSource="{Binding LocalItems}" SelectedItem="{Binding SelectedLocalItem}" SelectionMode="None">
                    <CollectionView.ItemTemplate>
            <DataTemplate x:DataType="io:FileSystemInfo">
                            <Grid Padding="6" InputTransparent="False">
                                <Label Text="{Binding Name}"/>
                                <Grid.GestureRecognizers>
                                    <DragGestureRecognizer CanDrag="True" DragStarting="OnLocalDragStarting" />
                    <TapGestureRecognizer NumberOfTapsRequired="2"
                             Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.OpenLocalFolderCommand}"
                             CommandParameter="{Binding .}" />
                    <TapGestureRecognizer NumberOfTapsRequired="1"
                             Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.ShowLocalActionsCommand}"
                             CommandParameter="{Binding .}" />
                    <TapGestureRecognizer Buttons="Secondary"
                             Command="{Binding Source={x:Reference RootPage}, Path=BindingContext.ShowLocalActionsCommand}"
                             CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                <Grid.GestureRecognizers>
                    <DropGestureRecognizer AllowDrop="True" Drop="OnLocalDrop" />
                </Grid.GestureRecognizers>
            </Grid>
        </Grid>

        <!-- Docked Terminal -->
    <Grid x:Name="TerminalContainer" Grid.Row="2" RowDefinitions="Auto,* ,Auto" BackgroundColor="{AppThemeBinding Light=#111111, Dark=#000000}" IsVisible="{Binding IsTerminalVisible}" HeightRequest="{Binding TerminalHeight}">
            <!-- Header with pin toggle -->
            <HorizontalStackLayout Padding="6" Spacing="10">
                <Label Text="Terminal" TextColor="White" FontAttributes="Bold"/>
                <ImageButton x:Name="PinButton" WidthRequest="32" HeightRequest="32" BackgroundColor="Transparent" Command="{Binding TogglePinCommand}"/>
            </HorizontalStackLayout>
            <ScrollView Grid.Row="1">
                <Label Text="{Binding TerminalOutput}" TextColor="White" LineBreakMode="WordWrap"/>
            </ScrollView>
            <Grid Grid.Row="2" ColumnDefinitions="*,Auto,Auto,Auto" Padding="6">
                <Entry Grid.Column="0" Text="{Binding TerminalInput}" Placeholder="Type command..."/>
                <Button Grid.Column="1" Text="Run" Command="{Binding ExecuteCommand}"/>
                <Button Grid.Column="2" Text="⬇" Command="{Binding DownloadSelectedCommand}"/>
                <Button Grid.Column="3" Text="⬆" Command="{Binding UploadSelectedCommand}"/>
            </Grid>
    </Grid>
    <!-- Hover/touch handle to bring terminal up -->
    <Grid Grid.Row="2" HeightRequest="12" BackgroundColor="Transparent">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <Border StrokeThickness="0" BackgroundColor="#3A3A3A" HeightRequest="6" WidthRequest="140" HorizontalOptions="Center" VerticalOptions="Center" StrokeShape="RoundRectangle 3,3,3,3">
            <Border.GestureRecognizers>
                <TapGestureRecognizer Command="{Binding ToggleTerminalCommand}"/>
                <PanGestureRecognizer PanUpdated="OnTerminalHandlePanUpdated" />
            </Border.GestureRecognizers>
        </Border>
        <Grid.GestureRecognizers>
            <TapGestureRecognizer Command="{Binding ToggleTerminalCommand}"/>
        </Grid.GestureRecognizers>
    </Grid>
    </Grid>
</ContentPage>
